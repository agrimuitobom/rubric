<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ルーブリック ジェネレーター</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    min-height: 100vh;
    background: linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0c1929 100%);
    font-family: 'Noto Sans JP', 'Hiragino Sans', sans-serif;
    color: #e8e8e8;
  }
  input, textarea, select, button { font-family: inherit; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  .fade-in { animation: fadeIn 0.5s ease-out both; }
  .fade-in-d1 { animation: fadeIn 0.5s ease-out 0.1s both; }
  .fade-in-d2 { animation: fadeIn 0.5s ease-out 0.2s both; }

  header {
    padding: 32px 24px 24px;
    text-align: center;
    position: relative;
  }
  .header-glow {
    position: absolute; top: 0; left: 0; right: 0; height: 200px;
    background: radial-gradient(ellipse at 50% 0%, rgba(46,134,193,0.15) 0%, transparent 70%);
    pointer-events: none;
  }
  h1 {
    font-size: 28px; font-weight: 700; letter-spacing: 0.05em;
    background: linear-gradient(135deg, #85c1e9, #fff, #85c1e9);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; margin-bottom: 8px;
  }
  .subtitle { font-size: 13px; color: #7fb3d8; letter-spacing: 0.15em; font-weight: 300; }

  main { max-width: 900px; margin: 0 auto; padding: 0 20px 40px; }

  .card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px; padding: 20px; margin-bottom: 20px;
  }
  .card-form { padding: 24px; }

  .label {
    font-size: 12px; color: #7fb3d8; font-weight: 500;
    letter-spacing: 0.1em; display: block; margin-bottom: 8px;
  }
  .input-row { display: flex; gap: 8px; }
  .text-input {
    flex: 1; padding: 10px 14px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.3);
    color: #e8e8e8; font-size: 14px; outline: none;
  }
  .text-input-lg { font-size: 15px; padding: 12px 14px; width: 100%; }
  textarea.text-input { resize: vertical; line-height: 1.7; width: 100%; }
  .hint { font-size: 11px; color: #5a8aaa; margin-top: 6px; }

  .btn-secondary {
    padding: 10px 16px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06);
    color: #7fb3d8; cursor: pointer; font-size: 13px; white-space: nowrap;
    transition: all 0.2s;
  }
  .btn-delete {
    padding: 10px 16px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06);
    color: #e74c3c; cursor: pointer; font-size: 13px; white-space: nowrap;
    transition: all 0.2s;
  }
  .btn-delete.confirm {
    border-color: rgba(231,76,60,0.5); background: rgba(231,76,60,0.15);
  }

  .levels-row { display: flex; gap: 8px; }
  .level-btn {
    flex: 1; padding: 10px 0; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.2);
    color: #7a7a7a; cursor: pointer; font-size: 16px; font-weight: 600;
    transition: all 0.2s;
  }
  .level-btn.active {
    border: 2px solid #2e86c1; background: rgba(46,134,193,0.2); color: #85c1e9;
  }

  .error-box {
    padding: 10px 14px; border-radius: 8px;
    background: rgba(192,57,43,0.15); border: 1px solid rgba(192,57,43,0.3);
    color: #e74c3c; font-size: 13px; margin-bottom: 16px;
  }
  .btn-generate {
    width: 100%; padding: 14px; border-radius: 10px; border: none;
    background: linear-gradient(135deg, #1a5276, #2e86c1);
    color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
    letter-spacing: 0.05em; transition: all 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .btn-generate:disabled {
    background: rgba(46,134,193,0.3); cursor: not-allowed;
  }
  .spinner {
    width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff; border-radius: 50%;
    animation: spin 0.8s linear infinite; display: inline-block;
  }

  .result-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
  }
  .result-title { font-size: 20px; font-weight: 600; color: #fff; }
  .result-actions { display: flex; gap: 8px; }
  .btn-new {
    padding: 8px 18px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06);
    color: #7fb3d8; cursor: pointer; font-size: 13px; font-weight: 500;
  }
  .btn-csv {
    padding: 8px 18px; border-radius: 8px; border: none;
    background: linear-gradient(135deg, #1a5276, #2e86c1);
    color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;
  }

  .table-wrap {
    overflow-x: auto; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.25);
  }
  table { width: 100%; border-collapse: collapse; font-size: 13px; line-height: 1.6; }
  th.col-criterion {
    padding: 14px 16px; text-align: left; background: rgba(0,0,0,0.4);
    color: #7fb3d8; font-weight: 600; font-size: 12px; letter-spacing: 0.1em;
    border-bottom: 2px solid rgba(46,134,193,0.3); min-width: 120px;
    position: sticky; left: 0; z-index: 1;
  }
  th.col-level {
    padding: 14px 16px; text-align: center; font-weight: 600;
    font-size: 12px; letter-spacing: 0.05em;
    border-bottom: 2px solid rgba(46,134,193,0.3); min-width: 160px;
  }
  .level-score { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
  td.row-criterion {
    padding: 14px 16px; font-weight: 600; color: #c5dbe8;
    background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.06);
    position: sticky; left: 0; z-index: 1; font-size: 13px;
  }
  td.row-desc {
    padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.06);
    border-left: 1px solid rgba(255,255,255,0.04);
    color: #d0d0d0; vertical-align: top; font-size: 12.5px;
  }
  .ai-note { font-size: 11px; color: #5a8aaa; margin-top: 12px; text-align: center; }

  /* Editable cells */
  td.row-desc[contenteditable="true"]:hover {
    outline: 1px dashed rgba(46,134,193,0.5);
    cursor: text;
  }
  td.row-criterion[contenteditable="true"]:hover {
    outline: 1px dashed rgba(46,134,193,0.5);
    cursor: text;
  }
  td[contenteditable="true"]:focus {
    outline: 2px solid #2e86c1;
    background: rgba(46,134,193,0.12) !important;
  }
  .edit-hint { font-size: 11px; color: #5a8aaa; margin-top: 4px; text-align: center; }

  /* API Key Guide */
  .guide-toggle {
    font-size: 12px; color: #7fb3d8; background: none; border: none;
    cursor: pointer; text-decoration: underline; padding: 0; margin-top: 6px;
    font-family: inherit;
  }
  .guide-toggle:hover { color: #85c1e9; }
  .guide-content {
    margin-top: 12px; padding: 16px; border-radius: 8px;
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
    font-size: 13px; line-height: 1.8; color: #c5dbe8;
  }
  .guide-content ol { padding-left: 20px; }
  .guide-content li { margin-bottom: 8px; }
  .guide-content a { color: #5dade2; text-decoration: underline; }
  .guide-content a:hover { color: #85c1e9; }
  .guide-content .guide-note {
    margin-top: 10px; padding: 8px 12px; border-radius: 6px;
    background: rgba(46,134,193,0.1); border-left: 3px solid #2e86c1;
    font-size: 12px; color: #7fb3d8;
  }

  /* History */
  .history-section { margin-top: 8px; }
  .history-toggle {
    font-size: 13px; color: #7fb3d8; background: none; border: none;
    cursor: pointer; font-family: inherit; font-weight: 500;
    display: flex; align-items: center; gap: 6px; padding: 0;
  }
  .history-toggle:hover { color: #85c1e9; }
  .history-toggle .arrow { font-size: 10px; transition: transform 0.2s; }
  .history-toggle .arrow.open { transform: rotate(90deg); }
  .history-list {
    margin-top: 12px; display: flex; flex-direction: column; gap: 8px;
  }
  .history-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; border-radius: 8px;
    background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08);
    cursor: pointer; transition: all 0.2s; gap: 8px;
  }
  .history-item:hover { border-color: rgba(46,134,193,0.4); background: rgba(46,134,193,0.08); }
  .history-item-info { flex: 1; min-width: 0; }
  .history-item-title {
    font-size: 13px; font-weight: 500; color: #c5dbe8;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .history-item-meta { font-size: 11px; color: #5a8aaa; margin-top: 2px; }
  .history-item-del {
    background: none; border: none; color: #e74c3c; cursor: pointer;
    font-size: 16px; padding: 4px 8px; opacity: 0.5; transition: opacity 0.2s;
    flex-shrink: 0;
  }
  .history-item-del:hover { opacity: 1; }
  .history-empty { font-size: 12px; color: #5a8aaa; padding: 8px 0; }
  .history-clear {
    font-size: 11px; color: #e74c3c; background: none; border: none;
    cursor: pointer; font-family: inherit; margin-top: 8px; padding: 0;
    opacity: 0.7;
  }
  .history-clear:hover { opacity: 1; }

  /* Print Layout */
  @media print {
    *, *::before, *::after { color: #000 !important; background: #fff !important; box-shadow: none !important; text-shadow: none !important; }
    body { background: #fff !important; padding: 0 !important; }
    main { max-width: 100% !important; padding: 0 !important; }

    /* Hide everything except result */
    header, #formSection, #historySection, .result-actions, .edit-hint, .ai-note { display: none !important; }
    #resultSection { display: block !important; }
    #resultSection.hidden { display: block !important; }

    .result-header { margin-bottom: 8px; }
    .result-title { font-size: 18pt !important; color: #000 !important; text-align: center; }

    .table-wrap { overflow: visible !important; border: none !important; background: none !important; }
    table { width: 100% !important; border-collapse: collapse !important; font-size: 9pt !important; line-height: 1.4 !important; page-break-inside: auto; }
    tr { page-break-inside: avoid; }

    th.col-criterion, th.col-level {
      background: #e8e8e8 !important; color: #000 !important;
      border: 1px solid #333 !important; padding: 6px 8px !important;
      position: static !important; font-size: 9pt !important;
    }
    .level-score { color: #000 !important; font-size: 12pt !important; }
    td.row-criterion {
      background: #f4f4f4 !important; color: #000 !important;
      border: 1px solid #333 !important; padding: 6px 8px !important;
      position: static !important; font-weight: 600 !important;
    }
    td.row-desc {
      border: 1px solid #333 !important; padding: 6px 8px !important;
      color: #000 !important; font-size: 8.5pt !important;
    }
    td[contenteditable] { outline: none !important; }

    @page { size: A4 landscape; margin: 12mm; }
  }

  .btn-print {
    padding: 8px 18px; border-radius: 8px; border: none;
    background: linear-gradient(135deg, #6c3483, #8e44ad);
    color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;
  }

  /* Responsive: Tablet */
  @media (max-width: 768px) {
    header { padding: 24px 16px 18px; }
    h1 { font-size: 22px; }
    .subtitle { font-size: 12px; }
    main { padding: 0 12px 32px; }
    .card { padding: 16px; }
    .card-form { padding: 18px; }

    .result-header { flex-direction: column; align-items: flex-start; }
    .result-actions { flex-wrap: wrap; width: 100%; }
    .result-actions button { flex: 1; min-width: 0; padding: 8px 10px; font-size: 12px; }

    .select-row { flex-direction: column; gap: 0; }

    th.col-level { min-width: 130px; }
  }

  /* Responsive: Phone */
  @media (max-width: 480px) {
    header { padding: 18px 12px 14px; }
    h1 { font-size: 19px; letter-spacing: 0.02em; }
    .subtitle { font-size: 11px; letter-spacing: 0.08em; }
    main { padding: 0 8px 24px; }
    .card { padding: 14px; border-radius: 10px; }
    .card-form { padding: 14px; }

    .label { font-size: 11px; }
    .text-input { font-size: 13px; padding: 9px 12px; }
    .text-input-lg { font-size: 14px; padding: 10px 12px; }
    .hint { font-size: 10px; }

    .input-row { flex-wrap: wrap; }
    .input-row .text-input { width: 100%; flex: 1 1 100%; }
    .input-row .btn-secondary,
    .input-row .btn-delete { flex: 1; text-align: center; }

    .levels-row { flex-wrap: wrap; gap: 6px; }
    .level-btn { flex: 0 0 calc(33.33% - 4px); padding: 8px 0; font-size: 14px; }

    .btn-generate { font-size: 14px; padding: 12px; }

    .result-title { font-size: 17px; }
    .result-actions { gap: 6px; }
    .result-actions button { font-size: 11px; padding: 7px 8px; }

    /* Card-style table for narrow screens */
    .table-wrap { border-radius: 10px; -webkit-overflow-scrolling: touch; }
    table { font-size: 12px; }
    th.col-criterion { min-width: 80px; padding: 10px 10px; font-size: 11px; }
    th.col-level { min-width: 120px; padding: 10px 10px; font-size: 11px; }
    .level-score { font-size: 15px; }
    td.row-criterion { padding: 10px 10px; font-size: 12px; }
    td.row-desc { padding: 10px; font-size: 11.5px; }

    .history-item { padding: 8px 10px; }
    .history-item-title { font-size: 12px; }
    .history-item-meta { font-size: 10px; }

    .guide-content { padding: 12px; font-size: 12px; }
    .guide-content li { margin-bottom: 6px; }
  }

  .mb-20 { margin-bottom: 20px; }
  .mb-24 { margin-bottom: 24px; }
  .hidden { display: none; }

  .form-group { margin-bottom: 20px; }

  /* Select inputs */
  .select-input {
    padding: 10px 14px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.3);
    color: #e8e8e8; font-size: 14px; outline: none;
    appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237fb3d8' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    padding-right: 32px; cursor: pointer; width: 100%;
  }
  .select-row { display: flex; gap: 12px; }
  .select-row > div { flex: 1; }

  /* Regenerate button */
  .btn-regen {
    padding: 8px 18px; border-radius: 8px;
    border: 1px solid rgba(46,134,193,0.4); background: rgba(46,134,193,0.1);
    color: #85c1e9; cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.2s;
  }
  .btn-regen:hover { background: rgba(46,134,193,0.2); }
</style>
</head>
<body>

<header>
  <div class="header-glow"></div>
  <h1 class="fade-in">ルーブリック ジェネレーター</h1>
  <p class="subtitle fade-in-d1">AI が評価指標を自動生成</p>
</header>

<main>
  <!-- API Key -->
  <section class="card fade-in-d1">
    <label class="label">GEMINI API KEY</label>
    <div class="input-row">
      <input id="apiKeyInput" type="password" class="text-input" placeholder="AIza...">
      <button id="toggleKeyBtn" class="btn-secondary" onclick="toggleApiKey()">表示</button>
      <button id="deleteKeyBtn" class="btn-delete hidden" onclick="handleDeleteKey()">キー削除</button>
    </div>
    <p class="hint">※ キーはブラウザにのみ保存されます。共有端末では使用後に「キー削除」してください。</p>
    <button class="guide-toggle" onclick="toggleGuide()">APIキーの取得方法を見る</button>
    <div id="apiGuide" class="guide-content hidden">
      <ol>
        <li><a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio</a> にアクセスし、Googleアカウントでログインします。</li>
        <li>画面上部の「APIキーを作成」ボタンをクリックします。</li>
        <li>プロジェクトを選択する画面が出た場合は、そのまま「新しいプロジェクトでAPIキーを作成」を選択します。</li>
        <li>表示されたAPIキー（<code>AIza...</code> で始まる文字列）をコピーします。</li>
        <li>このページの「GEMINI API KEY」欄に貼り付けてください。キーは自動的にブラウザに保存されます。</li>
      </ol>
      <div class="guide-note">
        無料枠には1日あたりのリクエスト上限（20〜50回程度）があります。ルーブリック生成用途であれば十分ですが、上限に達した場合は翌日にお試しください。
      </div>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="card fade-in-d1 history-section">
    <button class="history-toggle" onclick="toggleHistory()">
      <span class="arrow" id="historyArrow">▶</span>
      <span id="historyToggleLabel">生成履歴</span>
    </button>
    <div id="historyList" class="history-list hidden"></div>
  </section>

  <!-- Input Form -->
  <section id="formSection" class="card card-form fade-in-d2">
    <div class="form-group">
      <div class="select-row">
        <div>
          <label class="label">校種</label>
          <select id="schoolSelect" class="select-input">
            <option value="">指定しない</option>
            <option value="小学校">小学校</option>
            <option value="中学校">中学校</option>
            <option value="高等学校">高等学校</option>
            <option value="大学">大学</option>
            <option value="特別支援学校">特別支援学校</option>
          </select>
        </div>
        <div>
          <label class="label">教科</label>
          <select id="subjectSelect" class="select-input">
            <option value="">指定しない</option>
            <option value="国語">国語</option>
            <option value="数学・算数">数学・算数</option>
            <option value="英語・外国語">英語・外国語</option>
            <option value="理科">理科</option>
            <option value="社会・地歴公民">社会・地歴公民</option>
            <option value="音楽">音楽</option>
            <option value="美術・図工">美術・図工</option>
            <option value="保健体育">保健体育</option>
            <option value="技術・家庭">技術・家庭</option>
            <option value="情報">情報</option>
            <option value="農業">農業</option>
            <option value="商業">商業</option>
            <option value="工業">工業</option>
            <option value="総合的な学習の時間">総合的な学習の時間</option>
            <option value="道徳">道徳</option>
            <option value="特別活動">特別活動</option>
          </select>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="label">評価対象 *</label>
      <input id="subjectInput" type="text" class="text-input text-input-lg" placeholder="例：プレゼンテーション、レポート、栽培計画書">
    </div>
    <div class="form-group">
      <label class="label">評価観点（空欄の場合は AI が自動設定）</label>
      <textarea id="criteriaInput" class="text-input" rows="4" placeholder="例：&#10;内容の正確性&#10;論理的構成&#10;表現力&#10;独創性"></textarea>
      <p class="hint" style="margin-top:4px">改行またはカンマ区切りで複数入力できます</p>
    </div>
    <div class="mb-24">
      <label class="label">評価段階数</label>
      <div class="levels-row" id="levelsRow"></div>
    </div>
    <div id="errorBox" class="error-box hidden"></div>
    <button id="generateBtn" class="btn-generate" onclick="generate()">ルーブリックを生成</button>
  </section>

  <!-- Result -->
  <section id="resultSection" class="hidden fade-in">
    <div class="result-header">
      <h2 id="resultTitle" class="result-title"></h2>
      <div class="result-actions">
        <button class="btn-new" onclick="backToForm()">新規作成</button>
        <button class="btn-regen" onclick="regenerate()">再生成</button>
        <button class="btn-csv" onclick="exportCSV()">Teams CSV</button>
        <button class="btn-csv" onclick="exportExcel()" style="background:linear-gradient(135deg,#1a7a3a,#27ae60)">Excel出力</button>
        <button class="btn-print" onclick="window.print()">印刷</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="rubricTable"></table>
    </div>
    <p class="edit-hint">セルをクリックして内容を編集できます。編集内容はCSV・Excel・印刷にも反映されます。</p>
    <p class="ai-note">※ AIが生成した内容です。必要に応じて修正してご利用ください。</p>
  </section>
</main>

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
const SYSTEM_PROMPT = `# Role
あなたは教育工学と学習評価の専門家です。教員が入力した条件に基づき、客観的で信頼性の高い「ルーブリック（評価指標）」を構造化データとして生成します。

# Task
提供された「評価対象」「評価観点」「評価段階数」を元に、各セル（観点×段階）に具体的な行動指標を記述したルーブリックを生成してください。

# Output Requirements
1. 評価段階は、数値が大きいほど高評価（例：4が最高、1が最低）とします。
2. 各段階の記述（description）は、抽象的な言葉（例：「よくできている」）を避け、具体的な行動や成果物の状態（例：「〜を3つ以上指摘し、根拠を述べている」）を記述してください。
3. 出力は必ず以下のJSON形式のみで返してください。余計なテキストやマークダウンは不要です。

{
  "title": "string",
  "levels": [
    { "score": "integer", "label": "string (例: 卓越、達成、努力を要する)" }
  ],
  "rows": [
    {
      "criterion": "string (評価観点)",
      "descriptions": [
        { "score": "integer", "text": "string (その段階の具体的な評価基準文)" }
      ]
    }
  ]
}`;

const LEVEL_COLORS = {
  4: { bg: "#1a5276", text: "#fff" },
  3: { bg: "#2e86c1", text: "#fff" },
  2: { bg: "#85c1e9", text: "#1a1a1a" },
  1: { bg: "#d4e6f1", text: "#1a1a1a" },
};
const DEFAULT_COLORS = [
  { bg: "#1a5276", text: "#fff" },
  { bg: "#2471a3", text: "#fff" },
  { bg: "#5dade2", text: "#fff" },
  { bg: "#85c1e9", text: "#1a1a1a" },
  { bg: "#aed6f1", text: "#1a1a1a" },
  { bg: "#d4e6f1", text: "#1a1a1a" },
];

function getColor(score, total) {
  if (LEVEL_COLORS[score] && total <= 4) return LEVEL_COLORS[score];
  const idx = total - score;
  return DEFAULT_COLORS[Math.min(idx, DEFAULT_COLORS.length - 1)];
}

// State
let selectedLevels = 4;
let rubricData = null;
let deleteConfirm = false;
let lastGenerateParams = null;
let historyOpen = false;
const HISTORY_KEY = 'rubric_history';
const MAX_HISTORY = 20;

// DOM refs
const apiKeyInput = document.getElementById('apiKeyInput');
const toggleKeyBtn = document.getElementById('toggleKeyBtn');
const deleteKeyBtn = document.getElementById('deleteKeyBtn');
const schoolSelect = document.getElementById('schoolSelect');
const subjectSelect = document.getElementById('subjectSelect');
const subjectInput = document.getElementById('subjectInput');
const criteriaInput = document.getElementById('criteriaInput');
const levelsRow = document.getElementById('levelsRow');
const errorBox = document.getElementById('errorBox');
const generateBtn = document.getElementById('generateBtn');
const formSection = document.getElementById('formSection');
const resultSection = document.getElementById('resultSection');
const resultTitle = document.getElementById('resultTitle');
const rubricTable = document.getElementById('rubricTable');
const historyList = document.getElementById('historyList');
const historyArrow = document.getElementById('historyArrow');
const historyToggleLabel = document.getElementById('historyToggleLabel');

// Init
(function init() {
  try {
    const saved = localStorage.getItem('gemini_api_key');
    if (saved) {
      apiKeyInput.value = saved;
      deleteKeyBtn.classList.remove('hidden');
    }
  } catch {}

  apiKeyInput.addEventListener('input', function() {
    const key = this.value;
    deleteConfirm = false;
    deleteKeyBtn.textContent = 'キー削除';
    deleteKeyBtn.classList.remove('confirm');
    if (key) {
      deleteKeyBtn.classList.remove('hidden');
      try { localStorage.setItem('gemini_api_key', key); } catch {}
    } else {
      deleteKeyBtn.classList.add('hidden');
      try { localStorage.removeItem('gemini_api_key'); } catch {}
    }
  });

  renderLevels();
  renderHistory();
})();

function renderLevels() {
  levelsRow.innerHTML = '';
  [3, 4, 5, 6].forEach(n => {
    const btn = document.createElement('button');
    btn.className = 'level-btn' + (n === selectedLevels ? ' active' : '');
    btn.textContent = n + '段階';
    btn.onclick = () => { selectedLevels = n; renderLevels(); };
    levelsRow.appendChild(btn);
  });
}

function toggleApiKey() {
  const isPassword = apiKeyInput.type === 'password';
  apiKeyInput.type = isPassword ? 'text' : 'password';
  toggleKeyBtn.textContent = isPassword ? '隠す' : '表示';
}

function handleDeleteKey() {
  if (!deleteConfirm) {
    deleteConfirm = true;
    deleteKeyBtn.textContent = '本当に削除';
    deleteKeyBtn.classList.add('confirm');
    return;
  }
  apiKeyInput.value = '';
  deleteConfirm = false;
  deleteKeyBtn.textContent = 'キー削除';
  deleteKeyBtn.classList.remove('confirm');
  deleteKeyBtn.classList.add('hidden');
  try { localStorage.removeItem('gemini_api_key'); } catch {}
}

function showError(msg) {
  errorBox.textContent = msg;
  errorBox.classList.remove('hidden');
}
function hideError() {
  errorBox.classList.add('hidden');
}

async function generate() {
  hideError();
  const apiKey = apiKeyInput.value.trim();
  const subject = subjectInput.value.trim();
  if (!apiKey) { showError('APIキーを入力してください'); return; }
  if (!subject) { showError('評価対象を入力してください'); return; }

  const school = schoolSelect.value;
  const subjectArea = subjectSelect.value;
  const criteriaRaw = criteriaInput.value.trim();
  const criteriaList = criteriaRaw
    ? criteriaRaw.split(/[,、\n]+/).map(c => c.trim()).filter(Boolean)
    : [];

  const contextLines = [];
  if (school) contextLines.push(`校種: ${school}`);
  if (subjectArea) contextLines.push(`教科: ${subjectArea}`);

  const userMessage = `以下の条件でルーブリックをJSON形式で生成してください。

${contextLines.length > 0 ? contextLines.join('\n') + '\n' : ''}評価対象: ${subject}
評価観点: ${criteriaList.length > 0 ? criteriaList.join('、') : '適切な観点を3〜5つ自動で設定してください'}
評価段階数: ${selectedLevels}段階

JSONのみを出力してください。`;

  lastGenerateParams = { apiKey, userMessage };

  generateBtn.disabled = true;
  generateBtn.innerHTML = '<span class="spinner"></span>生成中...';

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
          contents: [{ parts: [{ text: userMessage }] }],
          generationConfig: { responseMimeType: 'application/json', temperature: 0.3 },
        }),
      }
    );

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData?.error?.message || `API Error: ${res.status}`);
    }

    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('レスポンスが空です');

    const cleaned = text.replace(/```json\n?|```\n?/g, '').trim();
    const parsed = JSON.parse(cleaned);
    if (!parsed.title || !parsed.levels || !parsed.rows) throw new Error('不正なJSON構造です');

    rubricData = parsed;
    saveToHistory(parsed);
    renderResult();
  } catch (e) {
    showError('生成エラー: ' + e.message);
  } finally {
    generateBtn.disabled = false;
    generateBtn.innerHTML = 'ルーブリックを生成';
  }
}

function renderResult() {
  formSection.classList.add('hidden');
  resultSection.classList.remove('hidden');
  resultTitle.textContent = rubricData.title;

  const sorted = [...rubricData.levels].sort((a, b) => b.score - a.score);

  let html = '<thead><tr>';
  html += '<th class="col-criterion">評価観点</th>';
  sorted.forEach(level => {
    const c = getColor(level.score, sorted.length);
    html += `<th class="col-level" style="background:${c.bg};color:${c.text}">
      <div class="level-score">${level.score}</div>${level.label}</th>`;
  });
  html += '</tr></thead><tbody>';

  rubricData.rows.forEach((row, ri) => {
    html += `<tr class="fade-in" style="animation-delay:${ri * 0.08}s">`;
    html += `<td class="row-criterion" contenteditable="true" data-row="${ri}" data-field="criterion">${esc(row.criterion)}</td>`;
    sorted.forEach(level => {
      const desc = row.descriptions.find(d => d.score === level.score);
      const c = getColor(level.score, sorted.length);
      html += `<td class="row-desc" contenteditable="true" data-row="${ri}" data-score="${level.score}" style="background:${c.bg}12">${esc(desc?.text || '')}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody>';
  rubricTable.innerHTML = html;

  // Attach blur listeners for syncing edits back to rubricData
  rubricTable.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
    cell.addEventListener('blur', function() {
      const ri = parseInt(this.dataset.row);
      if (this.dataset.field === 'criterion') {
        rubricData.rows[ri].criterion = this.textContent.trim();
      } else {
        const score = parseInt(this.dataset.score);
        const desc = rubricData.rows[ri].descriptions.find(d => d.score === score);
        if (desc) {
          desc.text = this.textContent.trim();
        } else {
          rubricData.rows[ri].descriptions.push({ score, text: this.textContent.trim() });
        }
      }
    });
  });
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

async function regenerate() {
  if (!lastGenerateParams) return;
  const { apiKey, userMessage } = lastGenerateParams;

  const regenBtn = document.querySelector('.btn-regen');
  regenBtn.disabled = true;
  regenBtn.textContent = '生成中...';

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
          contents: [{ parts: [{ text: userMessage }] }],
          generationConfig: { responseMimeType: 'application/json', temperature: 0.3 },
        }),
      }
    );

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData?.error?.message || `API Error: ${res.status}`);
    }

    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error('レスポンスが空です');

    const cleaned = text.replace(/```json\n?|```\n?/g, '').trim();
    const parsed = JSON.parse(cleaned);
    if (!parsed.title || !parsed.levels || !parsed.rows) throw new Error('不正なJSON構造です');

    rubricData = parsed;
    saveToHistory(parsed);
    renderResult();
  } catch (e) {
    alert('再生成エラー: ' + e.message);
  } finally {
    regenBtn.disabled = false;
    regenBtn.textContent = '再生成';
  }
}

function toggleGuide() {
  const guide = document.getElementById('apiGuide');
  const btn = guide.previousElementSibling;
  if (guide.classList.contains('hidden')) {
    guide.classList.remove('hidden');
    btn.textContent = 'APIキーの取得方法を閉じる';
  } else {
    guide.classList.add('hidden');
    btn.textContent = 'APIキーの取得方法を見る';
  }
}

function backToForm() {
  resultSection.classList.add('hidden');
  formSection.classList.remove('hidden');
  rubricData = null;
}

function exportCSV() {
  if (!rubricData) return;
  const q = s => '"' + String(s).replace(/"/g, '""') + '"';
  const sorted = [...rubricData.levels].sort((a, b) => b.score - a.score);
  const title = rubricData.title || '';
  const desc = (subjectInput.value || '').trim();
  const lines = [];
  // Line 1: Teams identification message
  lines.push(q('編集機能を最適化するため、この .csv を Microsoft Teams のルーブリックとしてアップロードします。'));
  // Line 2: Title, Description
  lines.push(q(title) + ',' + q(''));
  // Line 3: Detailed description
  lines.push(q(desc));
  // Line 4: Empty
  lines.push(q(''));
  // Line 5: Empty cell + level labels (no scores)
  lines.push(',' + sorted.map(l => q(l.label)).join(','));
  // Line 6+: Criterion rows
  rubricData.rows.forEach(row => {
    const cells = sorted.map(level => {
      const d = row.descriptions.find(dd => dd.score === level.score);
      return q(d?.text || '');
    });
    lines.push(q(row.criterion) + ',' + cells.join(','));
  });
  // Last line: version marker
  lines.push('v.11');

  const bom = '\uFEFF';
  const csv = bom + lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (title || 'rubric') + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function exportExcel() {
  if (!rubricData) return;
  const sorted = [...rubricData.levels].sort((a, b) => b.score - a.score);
  const wb = XLSX.utils.book_new();

  // Build data rows
  const header = ['評価観点', ...sorted.map(l => `${l.label}（${l.score}）`)];
  const dataRows = rubricData.rows.map(row => {
    return [row.criterion, ...sorted.map(level => {
      const d = row.descriptions.find(dd => dd.score === level.score);
      return d?.text || '';
    })];
  });

  // Title row
  const wsData = [[rubricData.title], header, ...dataRows];
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Column widths
  const colWidths = [{ wch: 18 }];
  sorted.forEach(() => colWidths.push({ wch: 32 }));
  ws['!cols'] = colWidths;

  // Merge title row across all columns
  ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: header.length - 1 } }];

  XLSX.utils.book_append_sheet(wb, ws, 'ルーブリック');
  XLSX.writeFile(wb, (rubricData.title || 'rubric') + '.xlsx');
}

// --- History ---
function getHistory() {
  try {
    return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  } catch { return []; }
}

function saveToHistory(data) {
  const history = getHistory();
  const entry = {
    id: Date.now(),
    title: data.title,
    date: new Date().toLocaleString('ja-JP'),
    levels: data.levels.length,
    rows: data.rows.length,
    data: data,
  };
  history.unshift(entry);
  if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch {}
  renderHistory();
}

function renderHistory() {
  const history = getHistory();
  const count = history.length;
  historyToggleLabel.textContent = `生成履歴${count > 0 ? '（' + count + '件）' : ''}`;

  if (!historyOpen) {
    historyList.classList.add('hidden');
    return;
  }
  historyList.classList.remove('hidden');

  if (count === 0) {
    historyList.innerHTML = '<p class="history-empty">履歴はまだありません</p>';
    return;
  }

  let html = '';
  history.forEach(entry => {
    html += `<div class="history-item" onclick="loadHistory(${entry.id})">
      <div class="history-item-info">
        <div class="history-item-title">${esc(entry.title)}</div>
        <div class="history-item-meta">${esc(entry.date)} ・ ${entry.rows}観点 × ${entry.levels}段階</div>
      </div>
      <button class="history-item-del" onclick="event.stopPropagation();deleteHistory(${entry.id})" title="削除">×</button>
    </div>`;
  });
  html += '<button class="history-clear" onclick="clearHistory()">履歴をすべて削除</button>';
  historyList.innerHTML = html;
}

function toggleHistory() {
  historyOpen = !historyOpen;
  historyArrow.classList.toggle('open', historyOpen);
  renderHistory();
}

function loadHistory(id) {
  const history = getHistory();
  const entry = history.find(h => h.id === id);
  if (!entry) return;
  rubricData = entry.data;
  renderResult();
}

function deleteHistory(id) {
  const history = getHistory().filter(h => h.id !== id);
  try { localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); } catch {}
  renderHistory();
}

function clearHistory() {
  if (!confirm('生成履歴をすべて削除しますか？')) return;
  try { localStorage.removeItem(HISTORY_KEY); } catch {}
  renderHistory();
}
</script>
</body>
</html>
